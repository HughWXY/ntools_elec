
% Plot meso contacts in the MRI recon as the center of the surrounding
% macro contacts
% Created by Xiaojing, 07/21/2015


% newPathName = '/space/mdeh5/1/halgdev/projects/pdelprato/Results/PM_XJ/NY439_Meso/MRI_recon_AddMeso';
newPathName = '/space/mdeh1/5/halgdev/projects/nyuproj/loc/NY523/';

params.subject = 'NY523';
% [elec_txt, mri_mat] = meta_file_MRI_recon(params.subject);
elec_txt = fullfile(newPathName,'NY523_fmri_062014_coor_MNI_LH_2016-02-21.txt');
mri_mat = '/space/mdeh1/5/halgdev/projects/nyuproj/loc/ch2_template_mni_lh_pial_090315.mat';

aa = strfind(elec_txt,'/');
txtFileName = elec_txt(aa(end)+1:end);
aa = strfind(txtFileName,'.');
newFileName = [txtFileName(1:aa-1), '_AddMeso', txtFileName(aa:end)];
elec_txt_new = fullfile(newPathName, newFileName);

searchn_surf = 0;


%% Calculate meso contact coordinates and write to .txt together with all the macros

if(1)    
    meso_sch = {...
        'GR01', {'G01', 'G02'};...
        'GR02', {'G02', 'G03'};...
        'GR03', {'G03', 'G04'};...
        'GR04', {'G01', 'G09'};...
        'GR05', {'G01', 'G02', 'G09', 'G10'};...
        'GR06', {'G02', 'G10'};...
        'GR07', {'G02', 'G03', 'G10', 'G11'};...
        'GR08', {'G03', 'G11'};...
        'GR09', {'G03', 'G04', 'G11', 'G12'};...
        'GR10', {'G09', 'G10'};...
        'GR11', {'G10', 'G11'};...
        'GR12', {'G11', 'G12'};...
        'GR13', {'G09', 'G17'};...
        'GR14', {'G09', 'G10', 'G17', 'G18'};
        'GR15', {'G10', 'G18'};...
        'GR16', {'G10', 'G11', 'G18', 'G19'};...
        'GR17', {'G11', 'G19'};...
        'GR18', {'G11', 'G12', 'G19', 'G20'};...
        'GR19', {'G12', 'G20'};...
        'GR20', {'G12', 'G13', 'G20', 'G21'};...
        'GR21', {'G13', 'G21'};...
        'GR22', {'G17', 'G18'};...
        'GR23', {'G18', 'G19'};...
        'GR24', {'G19', 'G20'};...
        'GR25', {'G20', 'G21'};...
        'GR26', {'G21', 'G22'};...
        'GR27', {'G22', 'G23'};...
        'GR28', {'G17', 'G25'};...
        'GR29', {'G17', 'G18', 'G25', 'G26'};...
        'GR30', {'G18', 'G26'};...
        'GR31', {'G18', 'G19', 'G26', 'G27'};...
        'GR32', {'G19', 'G27'};...
        'GR33', {'G19', 'G20', 'G27', 'G28'};...
        'GR34', {'G20', 'G28'};...
        'GR35', {'G20', 'G21', 'G28', 'G29'};...
        'GR36', {'G21', 'G29'};...
        'GR37', {'G21', 'G22', 'G29', 'G30'};...
        'GR38', {'G22', 'G30'};...
        'GR39', {'G22', 'G23', 'G30', 'G31'};...
        'GR40', {'G23', 'G31'};...
        'GR41', {'G23', 'G24', 'G31', 'G32'};...
        'GR42', {'G25', 'G26'};...
        'GR43', {'G26', 'G27'};...
        'GR44', {'G27', 'G28'};...
        'GR45', {'G28', 'G29'};...
        'GR46', {'G29', 'G30'};...
        'GR47', {'G30', 'G31'};...
        'GR48', {'G36', 'G37'};...
        'GR49', {'G37', 'G38'};...
        'GR50', {'G38', 'G39'};...
        'GR51', {'G39', 'G40'};...
        'GR52', {'G36', 'G44'};...
        'GR53', {'G36', 'G37', 'G44', 'G45'};...
        'GR54', {'G37', 'G45'};...
        'GR55', {'G37', 'G38', 'G45', 'G46'};...
        'GR56', {'G38', 'G46'};...
        'GR57', {'G38', 'G39', 'G46', 'G47'};...
        'GR58', {'G39', 'G47'};...
        'GR59', {'G39', 'G40', 'G47', 'G48'};...
        'GR60', {'G44', 'G45'};...
        'GR61', {'G45', 'G46'};...
        'GR62', {'G46', 'G47'};...
        'GR63', {'G47', 'G48'};...
        'GR64', {'G44', 'G45', 'G52', 'G53'}
        };
    
    %%%%%%% If meso contact names are not GRXX %%%%%%%
    for rps = 1:size(meso_sch, 1)
        meso_sch{rps,1} = strrep(meso_sch{rps,1}, 'R', 'S');
    end
    %%%%%%% If meso contact names are not GRXX %%%%%%%
    
    fid = fopen(elec_txt);
    elec_all = textscan(fid,'%s %f %f %f %s');
    elec_cell = [elec_all{1},num2cell(elec_all{2}),num2cell(elec_all{3}),num2cell(elec_all{4}), elec_all{5}];
    
    surf_brain = load(mri_mat);
    
    meso_corr = [];
    for ms = 1:size(meso_sch,1)
        
        macro_idx = cellfun(@(x) find(strcmpi(x, elec_all{1})), meso_sch{ms,2});
        macro_corr = cell2mat(elec_cell(macro_idx,2:4));
        avg_corr = mean(macro_corr, 1);
        
        if(searchn_surf)
            K = dsearchn(surf_brain.coords, avg_corr);
            meso_corr(ms,:) = surf_brain.coords(K,:);
        else
            meso_corr(ms,:) = avg_corr;
        end
        
    end
    
    elec_meso = [meso_sch(:,1), num2cell(meso_corr), repmat({'M'}, size(meso_sch,1), 1)];
    elec_everything = [elec_cell; elec_meso];
    
    ntools_elec_savetxt(elec_txt_new, elec_everything);
end

% Load pial-outer-smoothed surface
% surf = fs_load_subj('NY439_fmri_020614','lh','pial-outer-smoothed',0,'/space/mdeh3/3/halgdev/projects/nyuproj/subjects/');
% Can do: K = dsearchn(surf.vertices, avg_corr);


%% Plot all meso & macro contacts

aparc = fullfile('/space/mdeh1/5/halgdev/projects/nyuproj/loc/ch2.lh.aparc.annot');
NYU_ntools_elec_autoplot_XJ(elec_txt_new, mri_mat, aparc);

% plotdir = [newPathName, '/images/', params.subject, '_T1_GSM_lateral_lh', '_AddMeso.png'];
% export_fig(plotdir,'-a1','-nocrop');






